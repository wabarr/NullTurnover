---
title: "Untitled"
author: "Andrew Barr"
date: "October 20, 2015"
output: 
  html_document:
    keep_md: true
---

```{r}
library(ape)
library(NullTurnover)
library(ggplot2)
library(parallel)
library(dplyr)
theme_set(theme_bw(20))
knitr::opts_knit$set(fig.width=10, fig.height=10)
```

Trees produced by `phytools::pbtree(bibiP, bibiQ, n=50, t=10)`, using the per interval Foote rate average for the period examined by Bibi & Kiessling. 

```{r}
treez <- readRDS("treez.Rdata")
```

## Criterion

```{r cache=TRUE}
criteria <- seq(1.2, 1.9, 0.1)
criterionPulses <- mclapply(criteria, mc.cores=4, FUN=function(criterion){
  pulses <- sapply(treez, FUN=function(theTree){
    return(detectPulses(theTree, desiredBinNumber = 20, criterion = criterion)[[1]])
    })
  return(sum(pulses > 0) / length(pulses))
  })
```

```{r}
qplot(xmin=criteria - 0.03, xmax=criteria + 0.03, ymin=0, ymax=unlist(criterionPulses), geom="rect") + 
  scale_x_continuous(breaks=criteria) + 
  labs(x="Turnover pulse criterion (* IQR)", y="Proportion trees with pulses")

summary(lm(criteria~unlist(criterionPulses)))

```

```{r}
ggsave("FIG-PulseCriterionByPropTreesWithPulses.pdf", height=10, width=10 ,units = "in")
```

## Sample size

```{r cache=TRUE}
nTaxa <- sapply(treez, FUN=function(tree) {
  length(tree$tip.label)
})

summary(nTaxa)

nPulses <- sapply(treez, FUN=function(tree){
  detectPulses(tree, desiredBinNumber = 20)
})
summary(nPulses)
```

```{r cache=TRUE}

summary(lm(nTaxa~factor(nPulses)))

qplot(factor(nPulses), nTaxa, geom="boxplot", fill=factor(nPulses)) + 
  scale_fill_brewer(palette = "Blues", guide="none") + 
  labs(x="number of pulses detected", y="number of taxa") + 
  coord_flip()

ggsave("FIG-NPulsesByTaxaonCount.pdf", height=10, width=10 ,units = "in")

qplot(factor(nPulses), nTaxa, geom="violin", fill=factor(nPulses)) + 
  scale_fill_brewer(palette = "Blues", guide="none") + 
  labs(x="number of pulses detected", y="number of taxa") + 
  coord_flip()

```

## Bin number

*  For each bin number between 10 and 20, inclusive.
*  detect the number of pulses for each of the 2000 trees

```{r cache=TRUE}
binNumberPulses <- readRDS("binNumberPulses.Rdata")
#binNumberPulses <- mclapply(10:20, mc.cores=4, FUN=function(binNumber) {
# nPulses <- sapply(treez, FUN=function(theTree){
#    return(detectPulses(theTree, desiredBinNumber = binNumber))
#    })
# return(list(binNumber = binNumber, nPulses=nPulses))
#})
#
#binNumberPulses <- lapply(binNumberPulses, FUN=function(x){
#  data.frame(nPulses=x$nPulses, binNumber=rep(x$binNumber, length(x$nPulses)), nTaxa=nTaxa, treeID= 1:length(x$nPulses))
#})
#
#binNumberPulses <- do.call(rbind, binNumberPulses)
#saveRDS(binNumberPulses, file="binNumberPulses.Rdata")
```

## Sample trees repeatedly

```{r}
#sample one from each tree
sampBinNumberPulses <- lapply(1:100, 
                              FUN=function(x){
                                binNumberPulses %>% 
                                  group_by(treeID) %>% 
                                  sample_n(size=1)
                                })
```


## Group by bin Number, record count per bin number and number of trees with at least one pulse

```{r}
countNumPulses <- lapply(sampBinNumberPulses, FUN=function(x){
  x %>% 
    group_by(binNumber) %>%
    summarise(count=n(), numPulses=sum(nPulses), meanTaxPerBin=mean(nTaxa/binNumber))
})

countNumPulses <- do.call(plyr::rbind.fill, args = countNumPulses)

```

```{r cache=TRUE}
ggplot(countNumPulses, aes(x=numPulses/count, y=meanTaxPerBin)) + 
  geom_point() + 
  labs(x="proportion of trees with at least one pulse", y="mean number of taxa per bin") + 
  scale_y_continuous(breaks=seq(10, 20, 2)) + 
  stat_smooth() + 
  coord_flip()
ggsave("FIG-ProportionPulsesByMeanTaxaPerBin.pdf", height=10, width=10 ,units = "in")
#this is distinctly non linear, so do I need to do stats?
#summary(lm(nTaxa / binNumber ~ factor(nPulses), data=binNumberPulses))

```

```{r cache=TRUE}
ggplot(subset(countNumPulses, binNumber %in% seq(10, 20, 2)), aes(y=numPulses/count, x=binNumber, group=binNumber, fill=factor(binNumber))) + 
  geom_boxplot() + 
  labs(y="proportion of trees with at least one pulse", x="number of bins") + 
  scale_x_continuous(breaks=seq(10, 20, 2)) + 
  scale_fill_brewer(palette = "Blues", guide='none')
ggsave("FIG-ProportionPulsesByBinNumber.pdf", height=10, width=10 ,units = "in")
#summary(lm(binNumber ~ factor(nPulses), data=binNumberPulses))
```

